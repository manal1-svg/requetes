{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord - Système de Suivi des Requêtes</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease-out;
        }
        .modal.active {
            display: flex;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            width: 90%;
            max-width: 800px;
        }
        .detail-table {
            @apply w-full border-collapse text-sm;
        }
        .detail-table th, .detail-table td {
            @apply px-4 py-2 border-b border-gray-200;
        }
        .detail-table th {
            @apply font-semibold text-gray-600;
        }
        .detail-table td {
            @apply text-gray-800;
        }
        .badge {
            @apply px-2.5 py-1 text-xs font-medium rounded-full;
        }
        .status-circle {
            @apply w-3 h-3 rounded-full mr-2 inline-block;
        }
        .progress-bar {
            @apply w-24 bg-gray-200 rounded-full h-3;
        }
        .progress-bar div {
            @apply h-3 rounded-full bg-blue-600 transition-all duration-300;
        }
        .action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            min-width: 120px;
        }
        .btn-history {
            background-color: #f3f4f6;
            color: #4b5563;
            border: 1px solid #e5e7eb;
        }
        .btn-history:hover {
            background-color: #e5e7eb;
            transform: translateY(-1px);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .btn-download-response {
            background-color: #ecfdf5;
            color: #15803d;
            border: 1px solid #16a34a;
        }
        .btn-download-response:hover {
            background-color: #d1fae5;
            transform: translateY(-1px);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .btn-reminder {
            background-color: #fef3c7;
            color: #b45309;
            border: 1px solid #f59e0b;
        }
        .btn-reminder:hover {
            background-color: #fef9c3;
            transform: translateY(-1px);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .rappel-item {
            background: white;
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border-left: 4px solid;
            transition: all 0.2s ease;
        }
        .rappel-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .rappel-item.delivered {
            border-left-color: #10b981;
            background-color: #f0fdf4;
        }
        .rappel-item.sent {
            border-left-color: #f59e0b;
            background-color: #fffbeb;
        }
        .rappel-item.failed {
            border-left-color: #ef4444;
            background-color: #fef2f2;
        }
        .rappel-time {
            font-size: 0.75rem;
            color: #6b7280;
        }
        .rappel-message {
            font-size: 0.875rem;
            color: #374151;
        }
        .region-card {
            position: relative;
            padding: 1.25rem;
            border-radius: 0.75rem;
            background: white;
            border: 1px solid #e5e7eb;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }
        .region-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .region-card.status-repondu {
            border-color: #10b981;
        }
        .region-card.status-attente {
            border-color: #f59e0b;
        }
        .region-card.status-retard {
            border-color: #ef4444;
        }
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fade-out {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(10px); }
        }
        .animate-fade-in {
            animation: fade-in 0.3s ease-out forwards;
        }
        .animate-fade-out {
            animation: fade-out 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-blue-800 text-white shadow-md">
            <div class="p-6">
                <h2 class="text-xl font-bold">Système de Requêtes</h2>
                <p class="text-blue-200 text-sm">Suivi des correspondances</p>
            </div>
            <nav class="mt-4">
                <a href="{% url 'lettres:dashboard' %}" class="flex items-center px-6 py-3 bg-blue-900">
                    <i class="fas fa-tachometer-alt mr-3"></i>
                    Tableau de Bord
                </a>
                {% if user_role != 'saisie_ec' %}
                <a href="{% url 'lettres:destinations' %}" class="flex items-center px-6 py-3 hover:bg-blue-700">
                    <i class="fas fa-map-marker-alt mr-3"></i>
                    Destinations
                </a>
                <a href="{% url 'lettres:statistics' %}" class="flex items-center px-6 py-3 hover:bg-blue-700">
                    <i class="fas fa-chart-bar mr-3"></i>
                    Statistiques
                </a>
                <a href="{% url 'lettres:settings' %}" class="flex items-center px-6 py-3 hover:bg-blue-700">
                    <i class="fas fa-cog mr-3"></i>
                    Paramètres
                </a>
                {% endif %}
                <a href="{% url 'lettres:archive' %}" class="flex items-center px-6 py-3 hover:bg-blue-700">
                    <i class="fas fa-archive mr-3"></i>
                    Archives
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="bg-white shadow-sm border-b px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Tableau de Bord</h1>
                        <p class="text-gray-600">Système de suivi et gestion des Requêtes</p>
                    </div>
                    <form action="{% url 'lettres:logout' %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="flex items-center px-4 py-2 text-red-600 border border-red-300 rounded-md hover:bg-red-50">
                            <i class="fas fa-sign-out-alt mr-2"></i>
                            Déconnexion
                        </button>
                    </form>
                </div>
            </header>

            <!-- Main -->
            <main class="flex-1 overflow-auto p-6">
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white shadow rounded-lg p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-500">Total des Requêtes</p>
                                <h3 class="text-2xl font-bold">{{ total_lettres }}</h3>
                            </div>
                            <div class="p-3 bg-blue-100 rounded-full text-blue-600">
                                <i class="fas fa-envelope"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white shadow rounded-lg p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-500">En Cours</p>
                                <h3 class="text-2xl font-bold">{{ lettres_en_attente.count }}</h3>
                            </div>
                            <div class="p-3 bg-yellow-100 rounded-full text-yellow-600">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white shadow rounded-lg p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-500">Clôturées</p>
                                <h3 class="text-2xl font-bold">{{ lettres_repondues.count }}</h3>
                                {% if temps_moyen_reponse %}
                                <p class="text-xs text-gray-500 mt-1">Temps moyen: {{ temps_moyen_reponse|floatformat:0 }}h</p>
                                {% endif %}
                            </div>
                            <div class="p-3 bg-green-100 rounded-full text-green-600">
                                <i class="fas fa-check-circle"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white shadow rounded-lg p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-500">En Retard</p>
                                <h3 class="text-2xl font-bold">{{ lettres_en_retard.count }}</h3>
                            </div>
                            <div class="p-3 bg-red-100 rounded-full text-red-600">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- New Lettre Button -->
                <div class="flex justify-end mb-4">
                    <button onclick="openModal('newLettreModal')" class="flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        <i class="fas fa-plus mr-2"></i>
                        Nouvelle Requête
                    </button>
                </div>

                <!-- Filters and Search -->
                <div class="bg-white shadow rounded-lg mb-6">
                    <div class="p-4">
                        <div class="flex items-center gap-2 mb-4">
                            <i class="fas fa-filter text-blue-600"></i>
                            <h2 class="text-lg font-semibold">Filtres et Recherche</h2>
                        </div>
                        <form method="get" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                            <div class="relative">
                                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                <input type="text" name="search" value="{{ request.GET.search }}" placeholder="Rechercher..." 
                                       class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <select name="statut" class="border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Tous les statuts</option>
                                <option value="en_attente" {% if request.GET.statut == 'en_attente' %}selected{% endif %}>En attente</option>
                                <option value="repondu" {% if request.GET.statut == 'repondu' %}selected{% endif %}>Répondu</option>
                                <option value="en_retard" {% if request.GET.statut == 'en_retard' %}selected{% endif %}>En retard</option>
                            </select>
                            <select name="category" class="border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Toutes catégories</option>
                                {% for category in categories %}
                                <option value="{{ category }}" {% if request.GET.category == category %}selected{% endif %}>{{ category }}</option>
                                {% endfor %}
                            </select>
                            {% if user_role != 'saisie_ec' %}
                            <select name="destination" class="border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Toutes destinations</option>
                                {% for destination in destinations %}
                                <option value="{{ destination.id }}" {% if request.GET.destination == destination.id|stringformat:"s" %}selected{% endif %}>{{ destination.nom }}</option>
                                {% endfor %}
                            </select>
                            {% endif %}
                            <button type="submit" class="px-4 py-2 border border-gray-300 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200">
                                Filtrer
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Lettre List -->
                <div class="bg-white shadow-lg rounded-xl overflow-hidden border border-gray-100">
                    <div class="p-5 border-b border-gray-100 bg-gradient-to-r from-blue-50 to-indigo-50">
                        <h2 class="text-xl font-bold text-gray-800">Liste des Lettres</h2>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Sujet</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Catégorie</th>
                                    {% if user_role != 'saisie_ec' %}
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Destinations</th>
                                    {% endif %}
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Échéance</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Priorité</th>
                                    {% if user_role != 'saisie_ec' %}
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Progression</th>
                                    {% endif %}
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for item in page_obj %}
                                <tr class="hover:bg-gray-50 transition-colors duration-150">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <div class="flex-shrink-0 h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                                                <i class="fas fa-envelope text-blue-600"></i>
                                            </div>
                                            <div class="text-sm font-medium text-gray-900 max-w-xs truncate" title="{{ item.lettre.subject }}">
                                                {{ item.lettre.subject }}
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 py-1 text-xs font-medium rounded-full bg-indigo-100 text-indigo-800">
                                            {{ item.lettre.category }}
                                        </span>
                                    </td>
                                    {% if user_role != 'saisie_ec' %}
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex flex-wrap gap-1">
                                            {% if item.lettre.sent_to_all_destinations %}
                                                <span class="px-2 py-1 text-xs rounded-full bg-purple-100 text-purple-800 font-medium">
                                                    Toutes ({{ item.total_destinations }})
                                                </span>
                                            {% else %}
                                                {% for region in item.lettre.destinations.all|slice:":2" %}
                                                    <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800 font-medium">
                                                        {{ region.nom }}
                                                    </span>
                                                {% endfor %}
                                                {% if item.lettre.destinations.count > 2 %}
                                                    <span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800 font-medium">
                                                        +{{ item.lettre.destinations.count|add:"-2" }}
                                                    </span>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                    </td>
                                    {% endif %}
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <div class="flex items-center">
                                            <i class="far fa-calendar-alt text-gray-400 mr-1"></i>
                                            {{ item.lettre.date|date:"d/m/Y" }}
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center gap-2">
                                            <span class="text-sm text-gray-600">
                                                {{ item.lettre.deadline|date:"d/m/Y" }}
                                            </span>
                                            {% if item.days_overdue > 0 %}
                                                <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800 font-medium animate-pulse">
                                                    {{ item.days_overdue }}j retard
                                                </span>
                                            {% elif item.days_until_deadline <= 2 and item.lettre.statut == 'en_attente' %}
                                                <span class="px-2 py-1 text-xs rounded-full bg-orange-100 text-orange-800 font-medium">
                                                    {{ item.days_until_deadline }}j restant
                                                </span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-3 py-1 text-xs font-semibold rounded-full 
                                            {% if item.lettre.priority == 'high' %}bg-red-100 text-red-800
                                            {% elif item.lettre.priority == 'medium' %}bg-yellow-100 text-yellow-800
                                            {% else %}bg-green-100 text-green-800{% endif %}">
                                            {{ item.lettre.get_priority_display }}
                                        </span>
                                    </td>
                                    {% if user_role != 'saisie_ec' %}
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center gap-3">
                                            <div class="w-24 bg-gray-200 rounded-full h-2.5">
                                                <div class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" 
                                                     style="width: {% widthratio item.responded_count item.total_destinations 100 %}%">
                                                </div>
                                            </div>
                                            <span class="text-xs font-medium text-gray-500">
                                                {{ item.responded_count }}/{{ item.total_destinations }}
                                            </span>
                                        </div>
                                    </td>
                                    {% endif %}
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <div class="flex items-center gap-3">
                                            <button onclick="openDetailModal('{{ item.lettre.id }}')" 
                                                    class="text-blue-600 hover:text-blue-800 transition-colors duration-200" 
                                                    title="Voir détails">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            {% if item.lettre.statut == 'en_attente' or item.lettre.statut == 'en_retard' %}
                                                <button onclick="sendGlobalReminder('{{ item.lettre.id }}')" 
                                                        class="text-orange-600 hover:text-orange-800 transition-colors duration-200" 
                                                        title="Envoyer un rappel global">
                                                    <i class="fas fa-envelope"></i>
                                                </button>
                                            {% endif %}
                                            {% if item.lettre.response_template %}
                                                <a href="{{ item.lettre.response_template.url }}" 
                                                   class="text-green-600 hover:text-green-800 transition-colors duration-200" 
                                                   target="_blank" 
                                                   title="Télécharger le template">
                                                    <i class="fas fa-file-download"></i>
                                                </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="{% if user_role == 'saisie_ec' %}5{% else %}7{% endif %}" class="px-6 py-8 text-center">
                                        <div class="flex flex-col items-center justify-center text-gray-400">
                                            <i class="far fa-folder-open fa-2x mb-3"></i>
                                            <span class="text-lg font-medium">Aucune lettre trouvée</span>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    {% if page_obj.paginator.num_pages > 1 %}
                    <div class="px-6 py-4 border-t border-gray-200 bg-gray-50">
                        <div class="flex items-center justify-between">
                            <div class="text-sm text-gray-700">
                                Affichage de <span class="font-medium">{{ page_obj.start_index }}</span> à <span class="font-medium">{{ page_obj.end_index }}</span> sur <span class="font-medium">{{ page_obj.paginator.count }}</span> résultats
                            </div>
                            <div class="flex space-x-2">
                                {% if page_obj.has_previous %}
                                    <a href="?page={{ page_obj.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                                       class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors duration-200">
                                        <i class="fas fa-chevron-left mr-1"></i> Précédent
                                    </a>
                                {% endif %}
                                
                                {% for num in page_obj.paginator.page_range %}
                                    {% if page_obj.number == num %}
                                        <span class="px-4 py-2 border border-blue-500 rounded-md text-sm font-medium text-white bg-blue-600">
                                            {{ num }}
                                        </span>
                                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                        <a href="?page={{ num }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                                           class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors duration-200">
                                            {{ num }}
                                        </a>
                                    {% endif %}
                                {% endfor %}
                                
                                {% if page_obj.has_next %}
                                    <a href="?page={{ page_obj.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                                       class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors duration-200">
                                        Suivant <i class="fas fa-chevron-right ml-1"></i>
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- New Lettre Modal -->
                <div id="newLettreModal" class="modal">
                    <div class="modal-content max-w-4xl w-full">
                        {% include 'create_requet/new_lettres.html' %}
                    </div>
                </div>

                <!-- Detail Lettre Modal -->
                <div id="detailLettreModal" class="modal">
                    <div class="modal-content max-w-5xl w-full">
                        <div class="p-6 max-w-5xl w-full bg-white rounded-xl shadow-lg">
                            <div class="border-b border-gray-200 bg-gradient-to-r from-slate-50 to-blue-50 px-6 py-4 rounded-t-xl">
                                <div class="flex justify-between items-center">
                                    <h1 class="modal-title text-2xl font-bold text-slate-800">Détails de la Lettre</h1>
                                    <button type="button" class="text-slate-500 hover:text-slate-700 transition-colors duration-200" onclick="closeModal('detailLettreModal')" aria-label="Close">
                                        <i class="fas fa-times text-xl"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="modal-body mt-4 px-6">
                                <div class="mb-6">
                                    <h5 class="text-lg font-semibold text-slate-800 mb-4">Informations Générales</h5>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-slate-50 p-4 rounded-lg border border-slate-200">
                                        <div class="space-y-1">
                                            <p class="text-slate-500 text-xs font-medium">Sujet</p>
                                            <p class="font-medium text-slate-900 text-sm" id="detail-subject">N/A</p>
                                        </div>
                                        <div class="space-y-1">
                                            <p class="text-slate-500 text-xs font-medium">Catégorie</p>
                                            <span class="badge bg-violet-100 text-violet-800 px-2.5 py-0.5 rounded-full text-xs font-medium" id="detail-category">N/A</span>
                                        </div>
                                        <div class="space-y-1">
                                            <p class="text-slate-500 text-xs font-medium">Service</p>
                                            <span class="badge bg-sky-100 text-sky-800 px-2.5 py-0.5 rounded-full text-xs font-medium" id="detail-service-info">N/A</span>
                                        </div>
                                        <div class="space-y-1">
                                            <p class="text-slate-500 text-xs font-medium">Priorité</p>
                                            <span class="badge px-2.5 py-0.5 rounded-full text-xs font-medium" id="detail-priority">N/A</span>
                                        </div>
                                        <div class="space-y-1">
                                            <p class="text-slate-500 text-xs font-medium">Date de Réception</p>
                                            <p class="font-medium text-slate-900 text-sm" id="detail-date">N/A</p>
                                        </div>
                                        <div class="space-y-1">
                                            <p class="text-slate-500 text-xs font-medium">Échéance</p>
                                            <p class="font-medium text-slate-900 text-sm" id="detail-deadline-display">N/A</p>
                                        </div>
                                        <div class="space-y-1">
                                            <p class="text-slate-500 text-xs font-medium">Rappels Envoyés</p>
                                            <p class="font-medium text-slate-900 text-sm" id="detail-rappels-envoyes">0</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-6">
                                    <div class="flex items-center justify-between mb-2">
                                        <h5 class="text-lg font-semibold text-slate-800">
                                            <i class="fas fa-chart-line mr-2 text-blue-500"></i>
                                            Progression Globale
                                        </h5>
                                        <span class="text-sm text-slate-600" id="detail-progress-text">0/0 régions</span>
                                    </div>
                                    <div class="h-2.5 bg-slate-200 rounded-full overflow-hidden">
                                        <div class="h-full bg-gradient-to-r from-blue-500 to-blue-600 rounded-full transition-all duration-300" id="detail-progress-bar" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div class="mb-6">
                                    <h5 class="text-lg font-semibold text-slate-800 mb-4">
                                        <i class="fas fa-map-marker-alt mr-2 text-blue-500"></i>
                                        Statut par Région
                                    </h5>
                                    <div class="space-y-4" id="detail-regions-container">
                                        <!-- Regions will be populated dynamically -->
                                    </div>
                                </div>
                                <div class="border-t border-slate-200 pt-4">
                                    <button id="detail-template-button" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white text-sm font-medium rounded-lg shadow-md hover:from-blue-600 hover:to-blue-700 transition-all duration-200" style="display: none;">
                                        <i class="fas fa-file-download mr-2"></i>
                                        Télécharger le Template
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Rappels Modal -->
                <div id="rappelsModal" class="modal">
                    <div class="modal-content max-w-2xl w-full bg-white rounded-xl shadow-2xl overflow-hidden">
                        <div class="border-b border-gray-200 px-6 py-4 bg-gradient-to-r from-blue-50 to-indigo-50">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                                        <i class="fas fa-history text-blue-600 mr-2"></i>
                                        Historique des rappels - <span id="selectedRegionName" class="font-medium ml-1"></span>
                                    </h3>
                                    <p class="text-xs text-gray-500 mt-1">
                                        Email: <span id="selectedRegionEmail" class="text-gray-700"></span>
                                    </p>
                                </div>
                                <button type="button" class="text-gray-400 hover:text-gray-600 transition-colors transform hover:rotate-90" onclick="closeModal('rappelsModal')" aria-label="Close">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="mb-6 max-h-96 overflow-y-auto pr-2">
                                <div id="rappelsContainer" class="space-y-3">
                                    <!-- Rappels will be populated here -->
                                </div>
                            </div>
                            <div class="border-t border-gray-200 pt-4">
                                <h4 class="text-sm font-medium text-gray-500 mb-3 flex items-center">
                                    <i class="fas fa-bolt text-yellow-500 mr-2"></i>
                                    Actions rapides
                                </h4>
                                <button onclick="sendEmailReminder(selectedLettreId, selectedRegion)" 
                                        class="inline-flex items-center px-4 py-2.5 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200 transform hover:-translate-y-0.5">
                                    <i class="fas fa-paper-plane mr-2"></i>
                                    Envoyer un nouveau rappel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Global variables for tracking selected lettre and region
        let selectedLettreId = null;
        let selectedRegion = null;

        // Modal control functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Function to trigger template download
        function downloadTemplate(url) {
            if (url) {
                const link = document.createElement('a');
                link.href = url;
                link.download = '';
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                alert('Aucun fichier template disponible.');
            }
        }

        // Fetch and display lettre details
        function openDetailModal(lettreId) {
            fetch(`/lettre/${lettreId}/detail/`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value || '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erreur réseau ou serveur : ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('detail-subject').textContent = data.subject || 'N/A';
                document.getElementById('detail-service-info').textContent = data.service || 'N/A';
                document.getElementById('detail-category').textContent = data.category || 'N/A';
                document.getElementById('detail-date').textContent = data.date || 'N/A';
                document.getElementById('detail-rappels-envoyes').textContent = data.rappels_envoyes || '0';

                let deadlineContent = data.deadline || 'N/A';
                if (data.days_overdue > 0) {
                    deadlineContent += ` <span class="badge bg-red-100 text-red-800">${data.days_overdue}j retard</span>`;
                } else if (data.days_until_deadline <= 2 && data.statut === 'en_attente') {
                    deadlineContent += ` <span class="badge bg-orange-100 text-orange-800">${data.days_until_deadline}j restant</span>`;
                }
                document.getElementById('detail-deadline-display').innerHTML = deadlineContent;

                const priorityClass = data.priority === 'high' ? 'bg-red-600 text-white' : 
                                     data.priority === 'medium' ? 'bg-yellow-100 text-yellow-800' : 
                                     'bg-green-100 text-green-800';
                document.getElementById('detail-priority').textContent = data.get_priority_display || 'N/A';
                document.getElementById('detail-priority').className = `badge ${priorityClass}`;

                const respondedCount = data.destinations.filter(dest => dest.statut === 'repondu').length;
                const totalDestinations = data.destinations.length;
                const progressPercentage = totalDestinations ? (respondedCount / totalDestinations * 100) : 0;
                document.getElementById('detail-progress-bar').style.width = `${progressPercentage}%`;
                document.getElementById('detail-progress-text').textContent = `${respondedCount}/${totalDestinations} régions`;

                const regionsContainer = document.getElementById('detail-regions-container');
                regionsContainer.innerHTML = '';
                data.destinations.forEach(dest => {
                    const statusClass = dest.statut === 'repondu' ? 'bg-green-500' : 
                                       dest.statut === 'en_retard' ? 'bg-red-500' : 
                                       'bg-yellow-500';
                    const statusIcon = dest.statut === 'repondu' ? 'fas fa-check-circle' : 
                                      dest.statut === 'en_retard' ? 'fas fa-exclamation-circle' : 
                                      'fas fa-clock';
                    const statusLabel = dest.statut.replace('en_attente', 'En attente')
                                                  .replace('repondu', 'Répondu')
                                                  .replace('en_retard', 'En retard');

                    let waitingSince = '';
                    if ((dest.statut === 'en_attente' || dest.statut === 'en_retard') && data.date) {
                        const creationDate = new Date(data.date.split('/').reverse().join('-'));
                        const now = new Date();
                        const diffMs = now - creationDate;
                        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                        if (diffDays > 0) {
                            waitingSince = `En attente depuis ${diffDays} jour${diffDays !== 1 ? 's' : ''}`;
                        }
                    }

                    let responseInfo = '';
                    if (dest.statut === 'repondu' && dest.date_reponse) {
                        responseInfo = `Répondu le ${dest.date_reponse}`;
                    }

                    let lastReminder = '';
                    if ((dest.statut === 'en_attente' || dest.statut === 'en_retard') && dest.rappels && dest.rappels.length > 0) {
                        const latestReminder = dest.rappels.reduce((latest, r) => {
                            const rDate = new Date(`${r.date}T${r.time}`);
                            return !latest || rDate > new Date(`${latest.date}T${latest.time}`) ? r : latest;
                        }, null);
                        if (latestReminder) {
                            const rDate = new Date(`${latestReminder.date}T${latestReminder.time}`);
                            lastReminder = `Dernier rappel le ${rDate.toLocaleDateString('fr-FR')} à ${rDate.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}`;
                        }
                    }

                    const regionItem = document.createElement('div');
                    regionItem.className = `region-card status-${dest.statut.replace('en_', '')}`;
                    regionItem.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex items-center space-x-3">
                                <div class="status-circle ${statusClass}">
                                    <i class="${statusIcon} text-sm"></i>
                                </div>
                                <div>
                                    <h4 class="font-medium text-gray-900">${dest.nom}</h4>
                                    <div class="flex items-center space-x-2 mt-1">
                                        <span class="status-badge status-${dest.statut.replace('en_', '')}">${statusLabel}</span>
                                        ${dest.rappels && dest.rappels.length > 0 ? 
                                            `<span class="reminders-badge">
                                                <i class="fas fa-bell mr-1"></i>${dest.rappels.length}
                                            </span>` : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                ${dest.statut === 'repondu' && dest.response_file ? `
                                    <a href="${dest.response_file}" 
                                       class="action-btn btn-download-response" target="_blank">
                                        <i class="fas fa-download mr-1"></i>
                                        Télécharger Réponse
                                    </a>
                                ` : (dest.statut === 'en_attente' || dest.statut === 'en_retard') ? `
                                    <button onclick="sendEmailReminder('${lettreId}', '${dest.nom.replace(/'/g, "\\'")}')" 
                                            class="action-btn btn-reminder">
                                        <i class="fas fa-paper-plane mr-1"></i>
                                        Rappel
                                    </button>
                                ` : ''}
                                ${dest.rappels && dest.rappels.length > 0 ? `
                                    <button onclick="openRappelsModal('${lettreId}', '${dest.nom.replace(/'/g, "\\'")}')" 
                                            class="action-btn btn-history">
                                        <i class="fas fa-history mr-1"></i>
                                        Historique
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        ${responseInfo || waitingSince || lastReminder ? `
                        <div class="mt-3 text-sm text-gray-600 space-y-1">
                            ${responseInfo ? `<p><i class="fas fa-check-circle text-green-500 mr-1"></i>${responseInfo}</p>` : ''}
                            ${waitingSince ? `<p><i class="fas fa-clock text-yellow-500 mr-1"></i>${waitingSince}</p>` : ''}
                            ${lastReminder ? `<p><i class="fas fa-bell text-blue-500 mr-1"></i>${lastReminder}</p>` : ''}
                        </div>` : ''}
                    `;
                    regionsContainer.appendChild(regionItem);
                });

                const templateButton = document.getElementById('detail-template-button');
                if (data.response_template) {
                    templateButton.setAttribute('data-url', data.response_template);
                    templateButton.style.display = 'inline-flex';
                    templateButton.onclick = () => downloadTemplate(data.response_template);
                } else {
                    templateButton.style.display = 'none';
                    templateButton.onclick = null;
                }

                openModal('detailLettreModal');
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Une erreur est survenue lors du chargement des détails.');
            });
        }

        // Fetch and display rappels for a specific region
        function openRappelsModal(lettreId, regionName) {
            selectedLettreId = lettreId;
            selectedRegion = regionName;
            document.getElementById('selectedRegionName').textContent = regionName;
            
            fetch(`/lettre/${lettreId}/rappels/${encodeURIComponent(regionName)}/`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value || '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erreur réseau ou serveur : ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                const rappelsContainer = document.getElementById('rappelsContainer');
                rappelsContainer.innerHTML = data.rappels.length ? 
                    data.rappels.map(r => `
                        <div class="rappel-item ${r.status}">
                            <div class="flex items-start">
                                <div class="mr-3">
                                    <div class="rappel-icon ${r.type}">
                                        <i class="fas fa-envelope text-white"></i>
                                    </div>
                                </div>
                                <div class="flex-1">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h4 class="font-medium text-gray-900">${r.type === 'email' ? 'Email' : r.type === 'sms' ? 'SMS' : 'Notification'}</h4>
                                            <p class="rappel-time mt-1">
                                                <i class="far fa-clock mr-1"></i>
                                                ${r.date} à ${r.time}
                                            </p>
                                        </div>
                                        <span class="status-badge ${r.status}">
                                            ${r.status === 'delivered' ? 'Livré' : r.status === 'sent' ? 'Envoyé' : 'Échec'}
                                        </span>
                                    </div>
                                    <p class="rappel-message mt-2">${r.message}</p>
                                </div>
                            </div>
                        </div>
                    `).join('') : 
                    '<div class="text-center py-5 text-gray-500">Aucun rappel enregistré</div>';
                
                document.getElementById('selectedRegionEmail').textContent = data.email || 'N/A';
                openModal('rappelsModal');
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Une erreur est survenue lors du chargement des rappels.');
            });
        }

        // Send email reminder
        function sendEmailReminder(lettreId, destination) {
            console.log(`Sending reminder for lettre ${lettreId} to destination ${destination}`);
            fetch(`/lettre/${lettreId}/send_email_reminder/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value || '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ destination: destination })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(`Erreur réseau ou serveur : ${response.status} - ${errorData.message || 'Erreur inconnue'}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg flex items-center animate-fade-in';
                notification.innerHTML = `
                    <i class="fas fa-check-circle mr-2"></i>
                    ${data.message}
                `;
                document.body.appendChild(notification);
                setTimeout(() => {
                    notification.classList.add('animate-fade-out');
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
                // Refresh the detail modal to update rappels_envoyes and other data
                openDetailModal(lettreId);
            })
            .catch(error => {
                console.error('Erreur lors de l’envoi du rappel:', error);
                alert(`Erreur lors de l'envoi du rappel: ${error.message}`);
            });
        }

        // Send global reminder
        function sendGlobalReminder(lettreId) {
            if (confirm('Voulez-vous envoyer un rappel global à toutes les destinations concernées ?')) {
                fetch(`/lettre/${lettreId}/send_global_reminder/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value || '{{ csrf_token }}',
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erreur réseau ou serveur : ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    alert(data.message);
                    if (data.message.includes('succès')) {
                        window.location.reload();
                    }
                })
                .catch(error => {
                    console.error('Erreur lors de l’envoi du rappel global:', error);
                    alert('Erreur lors de l’envoi du rappel global: ' + error.message);
                });
            }
        }

        // Handle form submission for new lettre
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('#newLettreModal form');
            if (form) {
                form.addEventListener('submit', function(event) {
                    event.preventDefault();
                    const formData = new FormData(form);
                    fetch(form.action, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value || '{{ csrf_token }}',
                            'X-Requested-With': 'XMLHttpRequest',
                        },
                        body: formData
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Erreur réseau ou serveur : ' + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            alert(data.message);
                            window.location.reload();
                        } else {
                            alert('Erreur : ' + (data.errors || 'Veuillez vérifier les informations saisies.'));
                        }
                    })
                    .catch(error => {
                        console.error('Erreur lors de la soumission:', error);
                        alert('Erreur lors de la soumission du formulaire: ' + error.message);
                    });
                });
            }
        });
    </script>
</body>
</html>
